#!/usr/bin/env ruby

require_relative '../lib/linear'
require 'optparse'

def show_usage
  puts <<~USAGE
    Linear CLI - Ruby wrapper for Linear GraphQL API

    Usage:
      linear issue ISSUE_ID                   Fetch a specific issue by ID
      linear issues [OPTIONS]                 List and filter issues (all filters are optional)
      linear mine                             Show issues assigned to you
      linear teams                            List all teams
      linear projects                         List all projects
      linear comment ISSUE_ID COMMENT         Add a comment to an issue
      linear update ISSUE_ID [OPTIONS]        Update issue (at least one option required)
        --state STATE                         Update issue state
        --title TITLE                         Update issue title
        --description DESCRIPTION             Update issue description

    Issues Filters (all optional, can be combined):
      --query TEXT                      Search by title text
      --project PROJECT_ID              Filter by project ID
      --state STATE                     Filter by state name (case-insensitive)
      --team TEAM_KEY                   Filter by team key

    Examples:
      # View a specific issue
      linear issue ENG-123

      # List all issues
      linear issues

      # Search issues by title
      linear issues --query "authentication"

      # Filter by state (case-insensitive)
      linear issues --state backlog
      linear issues --state "In Progress"

      # Filter by team
      linear issues --team ENG

      # Combine multiple filters
      linear issues --query "bug" --state Backlog --team ENG
      linear issues --project abc123 --state Done

      # Your assigned issues
      linear mine

      # Other commands
      linear teams
      linear projects
      linear comment DEV-85 "This is done"

      # Update issue
      linear update DEV-85 --state "Done"
      linear update DEV-85 --title "New title"
      linear update DEV-85 --description "Updated description"
      linear update DEV-85 --state "In Progress" --title "Working on it" --description "Started implementation"

    Configuration:
      Set the LINEAR_API_KEY environment variable with your API key from:
      https://linear.app/settings/api
  USAGE
end

command = ARGV.shift

case command
when 'issue'
  issue_id = ARGV.shift
  if issue_id.nil? || issue_id.empty?
    puts "Error: issue ID required"
    puts "Usage: linear issue ISSUE_ID"
    exit 1
  end

  begin
    Linear::Commands.fetch_issue(issue_id)
  rescue => e
    puts "Error: #{e.message}"
    exit 1
  end

when 'mine'
  begin
    Linear::Commands.my_issues
  rescue => e
    puts "Error: #{e.message}"
    exit 1
  end

when 'teams'
  begin
    Linear::Commands.list_teams
  rescue => e
    puts "Error: #{e.message}"
    exit 1
  end

when 'projects'
  begin
    Linear::Commands.list_projects
  rescue => e
    puts "Error: #{e.message}"
    exit 1
  end

when 'issues'
  options = {}
  OptionParser.new do |opts|
    opts.on("--query QUERY", "Filter by title text") { |v| options[:query] = v }
    opts.on("--project PROJECT", "Filter by project ID") { |v| options[:project] = v }
    opts.on("--state STATE", "Filter by state name") { |v| options[:state] = v }
    opts.on("--team TEAM", "Filter by team key") { |v| options[:team] = v }
  end.parse!

  begin
    Linear::Commands.list_issues(options)
  rescue => e
    puts "Error: #{e.message}"
    exit 1
  end

when 'comment'
  issue_id = ARGV.shift
  comment_body = ARGV.shift

  if issue_id.nil? || issue_id.empty? || comment_body.nil? || comment_body.empty?
    puts "Error: issue ID and comment text required"
    puts "Usage: linear comment ISSUE_ID \"comment text\""
    exit 1
  end

  begin
    Linear::Commands.add_comment(issue_id, comment_body)
  rescue => e
    puts "Error: #{e.message}"
    exit 1
  end

when 'update'
  issue_id = ARGV.shift

  if issue_id.nil? || issue_id.empty?
    puts "Error: issue ID required"
    puts "Usage: linear update ISSUE_ID [--state STATE] [--title TITLE] [--description DESCRIPTION]"
    exit 1
  end

  options = {}
  OptionParser.new do |opts|
    opts.on("--state STATE", "Update issue state") { |v| options[:state] = v }
    opts.on("--title TITLE", "Update issue title") { |v| options[:title] = v }
    opts.on("--description DESCRIPTION", "Update issue description") { |v| options[:description] = v }
  end.parse!

  begin
    Linear::Commands.update_issue(
      issue_id,
      state: options[:state],
      title: options[:title],
      description: options[:description]
    )
  rescue => e
    puts "Error: #{e.message}"
    exit 1
  end

when 'help', '--help', '-h', nil
  show_usage

else
  puts "Unknown command: #{command}"
  puts ""
  show_usage
  exit 1
end
